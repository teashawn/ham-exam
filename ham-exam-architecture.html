<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HAM Exam App Architecture Explorer</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: system-ui, -apple-system, sans-serif;
      background: #0f0f0f;
      color: #e5e5e5;
      height: 100vh;
      overflow: hidden;
    }

    .container {
      display: grid;
      grid-template-columns: 280px 1fr;
      height: 100vh;
    }

    .sidebar {
      background: #1a1a1a;
      border-right: 1px solid #333;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .sidebar-header {
      padding: 16px;
      border-bottom: 1px solid #333;
    }

    .sidebar-header h1 {
      font-size: 14px;
      font-weight: 600;
      color: #fff;
      margin-bottom: 4px;
    }

    .sidebar-header p {
      font-size: 11px;
      color: #888;
    }

    .sidebar-section {
      padding: 12px 16px;
      border-bottom: 1px solid #333;
    }

    .sidebar-section h2 {
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: #666;
      margin-bottom: 10px;
    }

    .presets {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .preset-btn {
      background: #2a2a2a;
      border: 1px solid #444;
      color: #ccc;
      padding: 6px 10px;
      border-radius: 4px;
      font-size: 11px;
      cursor: pointer;
      transition: all 0.15s;
    }

    .preset-btn:hover {
      background: #3a3a3a;
      border-color: #555;
    }

    .preset-btn.active {
      background: #3b82f6;
      border-color: #3b82f6;
      color: #fff;
    }

    .layer-toggles {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .layer-toggle {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      padding: 4px 0;
    }

    .layer-toggle input {
      accent-color: #3b82f6;
    }

    .layer-dot {
      width: 10px;
      height: 10px;
      border-radius: 2px;
    }

    .layer-label {
      font-size: 12px;
      flex: 1;
    }

    .connection-toggles {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .connection-toggle {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      padding: 4px 0;
    }

    .connection-toggle input {
      accent-color: #3b82f6;
    }

    .connection-line {
      width: 20px;
      height: 3px;
      border-radius: 1px;
    }

    .connection-label {
      font-size: 12px;
      flex: 1;
    }

    .comments-section {
      flex: 1;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .comments-header {
      padding: 12px 16px 8px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .comments-header h2 {
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: #666;
    }

    .comment-count {
      background: #3b82f6;
      color: #fff;
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 10px;
    }

    .comments-list {
      flex: 1;
      overflow-y: auto;
      padding: 0 16px 16px;
    }

    .comment-item {
      background: #2a2a2a;
      border: 1px solid #444;
      border-radius: 6px;
      padding: 10px;
      margin-bottom: 8px;
    }

    .comment-item.has-comment {
      border-color: #f59e0b;
    }

    .comment-target {
      font-size: 11px;
      font-weight: 600;
      color: #fff;
      margin-bottom: 2px;
    }

    .comment-file {
      font-size: 10px;
      color: #666;
      font-family: monospace;
      margin-bottom: 6px;
    }

    .comment-text {
      font-size: 11px;
      color: #ccc;
      line-height: 1.4;
    }

    .comment-actions {
      display: flex;
      gap: 8px;
      margin-top: 8px;
    }

    .comment-btn {
      background: none;
      border: none;
      color: #888;
      font-size: 10px;
      cursor: pointer;
      padding: 2px 4px;
    }

    .comment-btn:hover {
      color: #fff;
    }

    .comment-btn.delete:hover {
      color: #ef4444;
    }

    .empty-comments {
      text-align: center;
      padding: 20px;
      color: #666;
      font-size: 12px;
    }

    .main {
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .canvas-container {
      flex: 1;
      position: relative;
      overflow: hidden;
      background: #0a0a0a;
    }

    .zoom-controls {
      position: absolute;
      top: 12px;
      right: 12px;
      display: flex;
      gap: 4px;
      z-index: 10;
    }

    .zoom-btn {
      background: #2a2a2a;
      border: 1px solid #444;
      color: #ccc;
      width: 28px;
      height: 28px;
      border-radius: 4px;
      font-size: 14px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .zoom-btn:hover {
      background: #3a3a3a;
    }

    #canvas {
      width: 100%;
      height: 100%;
      cursor: grab;
    }

    #canvas:active {
      cursor: grabbing;
    }

    .legend {
      position: absolute;
      bottom: 12px;
      left: 12px;
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 6px;
      padding: 10px 12px;
      font-size: 10px;
    }

    .legend-title {
      font-weight: 600;
      color: #888;
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .legend-items {
      display: flex;
      gap: 16px;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 6px;
      color: #aaa;
    }

    .legend-dot {
      width: 12px;
      height: 12px;
      border-radius: 2px;
    }

    .prompt-section {
      background: #1a1a1a;
      border-top: 1px solid #333;
      padding: 12px 16px;
      max-height: 200px;
      display: flex;
      flex-direction: column;
    }

    .prompt-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 8px;
    }

    .prompt-header h3 {
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: #666;
    }

    .copy-btn {
      background: #3b82f6;
      border: none;
      color: #fff;
      padding: 6px 12px;
      border-radius: 4px;
      font-size: 11px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .copy-btn:hover {
      background: #2563eb;
    }

    .copy-btn.copied {
      background: #10b981;
    }

    .prompt-output {
      flex: 1;
      background: #0a0a0a;
      border: 1px solid #333;
      border-radius: 4px;
      padding: 10px;
      font-family: monospace;
      font-size: 11px;
      line-height: 1.5;
      color: #ccc;
      overflow-y: auto;
      white-space: pre-wrap;
    }

    /* Modal */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.7);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 100;
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal {
      background: #1a1a1a;
      border: 1px solid #444;
      border-radius: 8px;
      width: 400px;
      max-width: 90vw;
    }

    .modal-header {
      padding: 16px;
      border-bottom: 1px solid #333;
    }

    .modal-title {
      font-size: 14px;
      font-weight: 600;
      color: #fff;
      margin-bottom: 4px;
    }

    .modal-subtitle {
      font-size: 11px;
      color: #888;
      font-family: monospace;
    }

    .modal-body {
      padding: 16px;
    }

    .modal-textarea {
      width: 100%;
      height: 120px;
      background: #0a0a0a;
      border: 1px solid #444;
      border-radius: 4px;
      color: #fff;
      font-family: system-ui;
      font-size: 13px;
      padding: 10px;
      resize: vertical;
    }

    .modal-textarea:focus {
      outline: none;
      border-color: #3b82f6;
    }

    .modal-hint {
      font-size: 11px;
      color: #666;
      margin-top: 8px;
    }

    .modal-footer {
      padding: 12px 16px;
      border-top: 1px solid #333;
      display: flex;
      justify-content: flex-end;
      gap: 8px;
    }

    .modal-btn {
      padding: 8px 16px;
      border-radius: 4px;
      font-size: 12px;
      cursor: pointer;
      border: 1px solid #444;
    }

    .modal-btn.cancel {
      background: #2a2a2a;
      color: #ccc;
    }

    .modal-btn.save {
      background: #3b82f6;
      border-color: #3b82f6;
      color: #fff;
    }

    .modal-btn:hover {
      opacity: 0.9;
    }

    /* Node styles */
    .node {
      cursor: pointer;
      transition: transform 0.1s;
    }

    .node:hover rect {
      filter: brightness(1.1);
    }

    .node.commented rect {
      stroke: #f59e0b;
      stroke-width: 2;
    }

    .node-label {
      font-family: system-ui;
      font-size: 11px;
      font-weight: 600;
      fill: #1a1a1a;
      pointer-events: none;
    }

    .node-subtitle {
      font-family: monospace;
      font-size: 8px;
      fill: #666;
      pointer-events: none;
    }

    .comment-indicator {
      fill: #f59e0b;
    }
  </style>
</head>
<body>
  <div class="container">
    <aside class="sidebar">
      <div class="sidebar-header">
        <h1>HAM Exam Architecture</h1>
        <p>Click any node to add a comment or question</p>
      </div>

      <div class="sidebar-section">
        <h2>View Presets</h2>
        <div class="presets">
          <button class="preset-btn active" data-preset="full">Full System</button>
          <button class="preset-btn" data-preset="data-flow">Data Flow</button>
          <button class="preset-btn" data-preset="frontend">Frontend</button>
          <button class="preset-btn" data-preset="core">Core Logic</button>
          <button class="preset-btn" data-preset="fsrs">FSRS System</button>
        </div>
      </div>

      <div class="sidebar-section">
        <h2>Layers</h2>
        <div class="layer-toggles">
          <label class="layer-toggle">
            <input type="checkbox" data-layer="ui" checked>
            <span class="layer-dot" style="background: #dbeafe"></span>
            <span class="layer-label">UI Components</span>
          </label>
          <label class="layer-toggle">
            <input type="checkbox" data-layer="hooks" checked>
            <span class="layer-dot" style="background: #e0e7ff"></span>
            <span class="layer-label">React Hooks</span>
          </label>
          <label class="layer-toggle">
            <input type="checkbox" data-layer="core" checked>
            <span class="layer-dot" style="background: #f3e8ff"></span>
            <span class="layer-label">Core Logic</span>
          </label>
          <label class="layer-toggle">
            <input type="checkbox" data-layer="storage" checked>
            <span class="layer-dot" style="background: #fce7f3"></span>
            <span class="layer-label">Storage</span>
          </label>
          <label class="layer-toggle">
            <input type="checkbox" data-layer="data" checked>
            <span class="layer-dot" style="background: #dcfce7"></span>
            <span class="layer-label">Data Sources</span>
          </label>
        </div>
      </div>

      <div class="sidebar-section">
        <h2>Connections</h2>
        <div class="connection-toggles">
          <label class="connection-toggle">
            <input type="checkbox" data-connection="imports" checked>
            <span class="connection-line" style="background: #6b7280"></span>
            <span class="connection-label">Imports</span>
          </label>
          <label class="connection-toggle">
            <input type="checkbox" data-connection="data-flow" checked>
            <span class="connection-line" style="background: #3b82f6"></span>
            <span class="connection-label">Data Flow</span>
          </label>
          <label class="connection-toggle">
            <input type="checkbox" data-connection="calls" checked>
            <span class="connection-line" style="background: #10b981"></span>
            <span class="connection-label">Function Calls</span>
          </label>
        </div>
      </div>

      <div class="comments-section">
        <div class="comments-header">
          <h2>Comments</h2>
          <span class="comment-count" id="comment-count">0</span>
        </div>
        <div class="comments-list" id="comments-list">
          <div class="empty-comments">Click a node to add a comment</div>
        </div>
      </div>
    </aside>

    <main class="main">
      <div class="canvas-container">
        <div class="zoom-controls">
          <button class="zoom-btn" id="zoom-in">+</button>
          <button class="zoom-btn" id="zoom-out">−</button>
          <button class="zoom-btn" id="zoom-reset">⟲</button>
        </div>

        <svg id="canvas" viewBox="0 0 1000 600">
          <defs>
            <marker id="arrow-gray" markerWidth="8" markerHeight="6" refX="7" refY="3" orient="auto">
              <polygon points="0 0, 8 3, 0 6" fill="#6b7280"/>
            </marker>
            <marker id="arrow-blue" markerWidth="8" markerHeight="6" refX="7" refY="3" orient="auto">
              <polygon points="0 0, 8 3, 0 6" fill="#3b82f6"/>
            </marker>
            <marker id="arrow-green" markerWidth="8" markerHeight="6" refX="7" refY="3" orient="auto">
              <polygon points="0 0, 8 3, 0 6" fill="#10b981"/>
            </marker>
          </defs>
          <g id="connections-layer"></g>
          <g id="nodes-layer"></g>
        </svg>

        <div class="legend">
          <div class="legend-title">Packages</div>
          <div class="legend-items">
            <div class="legend-item">
              <span class="legend-dot" style="background: #dbeafe"></span>
              <span>web</span>
            </div>
            <div class="legend-item">
              <span class="legend-dot" style="background: #f3e8ff"></span>
              <span>exam-core</span>
            </div>
            <div class="legend-item">
              <span class="legend-dot" style="background: #dcfce7"></span>
              <span>extractor</span>
            </div>
          </div>
        </div>
      </div>

      <div class="prompt-section">
        <div class="prompt-header">
          <h3>Generated Prompt</h3>
          <button class="copy-btn" id="copy-btn">
            <span>Copy Prompt</span>
          </button>
        </div>
        <div class="prompt-output" id="prompt-output">Select components and add comments to generate a prompt...</div>
      </div>
    </main>
  </div>

  <div class="modal-overlay" id="modal">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title" id="modal-title">Component Name</div>
        <div class="modal-subtitle" id="modal-subtitle">file/path.ts</div>
      </div>
      <div class="modal-body">
        <textarea class="modal-textarea" id="modal-textarea" placeholder="Add your comment, question, or request about this component..."></textarea>
        <div class="modal-hint">Press Ctrl+Enter to save</div>
      </div>
      <div class="modal-footer">
        <button class="modal-btn cancel" id="modal-cancel">Cancel</button>
        <button class="modal-btn save" id="modal-save">Save Comment</button>
      </div>
    </div>
  </div>

  <script>
    // Architecture data for HAM Exam App
    const nodes = [
      // UI Layer (web package)
      { id: 'app', label: 'App.tsx', subtitle: 'packages/web/src/App.tsx', x: 480, y: 40, w: 120, h: 40, layer: 'ui', color: '#dbeafe', description: 'Main React component, master state container with 8 app views' },
      { id: 'mode-select', label: 'ModeSelectView', subtitle: 'ModeSelectView.tsx', x: 200, y: 120, w: 130, h: 40, layer: 'ui', color: '#dbeafe', description: 'Choose between Study and Exam modes' },
      { id: 'exam-home', label: 'ExamHomeView', subtitle: 'ExamHomeView.tsx', x: 350, y: 120, w: 120, h: 40, layer: 'ui', color: '#dbeafe', description: 'Exam dashboard, start exam, view history' },
      { id: 'study-home', label: 'StudyHomeView', subtitle: 'StudyHomeView.tsx', x: 490, y: 120, w: 130, h: 40, layer: 'ui', color: '#dbeafe', description: 'Study sections, FSRS stats, progress tracking' },
      { id: 'exam-screen', label: 'Exam Screen', subtitle: 'App.tsx (exam view)', x: 350, y: 200, w: 110, h: 40, layer: 'ui', color: '#dbeafe', description: 'Active exam question display and navigation' },
      { id: 'study-screen', label: 'Study Screen', subtitle: 'App.tsx (study view)', x: 520, y: 200, w: 110, h: 40, layer: 'ui', color: '#dbeafe', description: 'Study mode with FSRS spaced repetition' },
      { id: 'grade-buttons', label: 'GradeButtons', subtitle: 'StudyGradeButtons.tsx', x: 670, y: 200, w: 120, h: 40, layer: 'ui', color: '#dbeafe', description: 'FSRS rating buttons (Again/Hard/Good/Easy)' },
      { id: 'results', label: 'Results Screen', subtitle: 'App.tsx (results)', x: 350, y: 280, w: 110, h: 40, layer: 'ui', color: '#dbeafe', description: 'Exam results with score breakdown' },

      // Hooks Layer
      { id: 'use-url-nav', label: 'useUrlNavigation', subtitle: 'hooks/useUrlNavigation.ts', x: 120, y: 200, w: 130, h: 40, layer: 'hooks', color: '#e0e7ff', description: 'URL state for browser back/forward' },
      { id: 'use-srs', label: 'useSRS', subtitle: 'hooks/useSRS.ts', x: 670, y: 280, w: 100, h: 40, layer: 'hooks', color: '#e0e7ff', description: 'FSRS state management hook' },
      { id: 'use-swipe', label: 'useSwipe', subtitle: 'hooks/useSwipe.ts', x: 520, y: 280, w: 100, h: 40, layer: 'hooks', color: '#e0e7ff', description: 'Swipe gesture detection for mobile' },

      // Core Logic Layer (exam-core package)
      { id: 'engine', label: 'engine.ts', subtitle: 'packages/exam-core/src/engine.ts', x: 250, y: 380, w: 110, h: 40, layer: 'core', color: '#f3e8ff', description: 'Exam session creation, scoring, completion' },
      { id: 'study-core', label: 'study.ts', subtitle: 'packages/exam-core/src/study.ts', x: 380, y: 380, w: 100, h: 40, layer: 'core', color: '#f3e8ff', description: 'Study session, progress tracking' },
      { id: 'fsrs-core', label: 'fsrs.ts', subtitle: 'packages/exam-core/src/fsrs.ts', x: 500, y: 380, w: 100, h: 40, layer: 'core', color: '#f3e8ff', description: 'FSRS spaced repetition algorithm' },
      { id: 'types', label: 'types.ts', subtitle: 'packages/exam-core/src/types.ts', x: 620, y: 380, w: 100, h: 40, layer: 'core', color: '#f3e8ff', description: 'All TypeScript type definitions' },
      { id: 'storage-core', label: 'storage.ts', subtitle: 'packages/exam-core/src/storage.ts', x: 130, y: 380, w: 100, h: 40, layer: 'core', color: '#f3e8ff', description: 'StorageAdapter pattern for persistence' },

      // Storage Layer
      { id: 'storage-web', label: 'storage.ts', subtitle: 'packages/web/src/lib/storage.ts', x: 80, y: 480, w: 110, h: 40, layer: 'storage', color: '#fce7f3', description: 'localStorage wrapper for exam-core' },
      { id: 'db', label: 'db.ts', subtitle: 'packages/web/src/lib/db.ts', x: 210, y: 480, w: 100, h: 40, layer: 'storage', color: '#fce7f3', description: 'Dexie IndexedDB for FSRS cards' },
      { id: 'local-storage', label: 'localStorage', subtitle: 'Browser API', x: 80, y: 550, w: 110, h: 35, layer: 'storage', color: '#fce7f3', description: 'User profile, config, exam history' },
      { id: 'indexed-db', label: 'IndexedDB', subtitle: 'Browser API', x: 210, y: 550, w: 100, h: 35, layer: 'storage', color: '#fce7f3', description: 'FSRS cards and review logs' },

      // Data Sources
      { id: 'exam-data', label: 'exam-questions.json', subtitle: 'packages/web/src/data/', x: 750, y: 120, w: 150, h: 40, layer: 'data', color: '#dcfce7', description: '~500 questions extracted from PDF' },
      { id: 'ts-fsrs', label: 'ts-fsrs', subtitle: 'npm package', x: 750, y: 380, w: 100, h: 40, layer: 'data', color: '#dcfce7', description: 'FSRS algorithm implementation' },

      // Extractor Package
      { id: 'parser', label: 'parser.ts', subtitle: 'packages/extractor/src/parser.ts', x: 860, y: 200, w: 110, h: 40, layer: 'data', color: '#dcfce7', description: 'PDF parsing, text normalization' },
      { id: 'pdf-files', label: 'PDF Documents', subtitle: 'docs/', x: 860, y: 280, w: 110, h: 40, layer: 'data', color: '#dcfce7', description: 'Source exam PDF files' },
    ];

    const connections = [
      // App to views
      { from: 'app', to: 'mode-select', type: 'data-flow', label: 'renders' },
      { from: 'app', to: 'exam-home', type: 'data-flow', label: 'renders' },
      { from: 'app', to: 'study-home', type: 'data-flow', label: 'renders' },
      { from: 'app', to: 'exam-screen', type: 'data-flow', label: 'renders' },
      { from: 'app', to: 'study-screen', type: 'data-flow', label: 'renders' },
      { from: 'app', to: 'results', type: 'data-flow', label: 'renders' },

      // Hooks usage
      { from: 'app', to: 'use-url-nav', type: 'calls', label: 'uses' },
      { from: 'study-screen', to: 'use-srs', type: 'calls', label: 'uses' },
      { from: 'study-screen', to: 'use-swipe', type: 'calls', label: 'uses' },
      { from: 'study-screen', to: 'grade-buttons', type: 'data-flow', label: 'renders' },

      // Core imports
      { from: 'app', to: 'engine', type: 'imports', label: 'imports' },
      { from: 'app', to: 'study-core', type: 'imports', label: 'imports' },
      { from: 'app', to: 'storage-core', type: 'imports', label: 'imports' },
      { from: 'use-srs', to: 'fsrs-core', type: 'imports', label: 'imports' },
      { from: 'use-srs', to: 'db', type: 'calls', label: 'uses' },

      // Core dependencies
      { from: 'engine', to: 'types', type: 'imports' },
      { from: 'study-core', to: 'types', type: 'imports' },
      { from: 'fsrs-core', to: 'types', type: 'imports' },
      { from: 'fsrs-core', to: 'ts-fsrs', type: 'imports', label: 'wraps' },
      { from: 'storage-core', to: 'types', type: 'imports' },

      // Storage flow
      { from: 'storage-web', to: 'storage-core', type: 'imports', label: 'wraps' },
      { from: 'storage-web', to: 'local-storage', type: 'data-flow', label: 'read/write' },
      { from: 'db', to: 'indexed-db', type: 'data-flow', label: 'read/write' },
      { from: 'db', to: 'types', type: 'imports' },

      // Data flow
      { from: 'app', to: 'exam-data', type: 'data-flow', label: 'loads' },
      { from: 'parser', to: 'exam-data', type: 'data-flow', label: 'generates' },
      { from: 'pdf-files', to: 'parser', type: 'data-flow', label: 'input' },

      // Exam flow
      { from: 'exam-screen', to: 'engine', type: 'calls', label: 'recordAnswer' },
      { from: 'exam-home', to: 'engine', type: 'calls', label: 'createSession' },
      { from: 'results', to: 'engine', type: 'calls', label: 'calculateScore' },

      // Study flow
      { from: 'study-home', to: 'study-core', type: 'calls', label: 'getProgress' },
      { from: 'study-screen', to: 'study-core', type: 'calls', label: 'markViewed' },
    ];

    // State
    const state = {
      layers: { ui: true, hooks: true, core: true, storage: true, data: true },
      connections: { imports: true, 'data-flow': true, calls: true },
      comments: [],
      activePreset: 'full',
      zoom: 1,
      pan: { x: 0, y: 0 },
      dragging: false,
      lastMouse: { x: 0, y: 0 },
      selectedNode: null
    };

    // Presets
    const presets = {
      full: { layers: { ui: true, hooks: true, core: true, storage: true, data: true }, connections: { imports: true, 'data-flow': true, calls: true } },
      'data-flow': { layers: { ui: true, hooks: false, core: true, storage: true, data: true }, connections: { imports: false, 'data-flow': true, calls: false } },
      frontend: { layers: { ui: true, hooks: true, core: false, storage: false, data: false }, connections: { imports: false, 'data-flow': true, calls: true } },
      core: { layers: { ui: false, hooks: false, core: true, storage: true, data: false }, connections: { imports: true, 'data-flow': true, calls: false } },
      fsrs: { layers: { ui: true, hooks: true, core: true, storage: true, data: true }, connections: { imports: true, 'data-flow': true, calls: true }, filter: ['study-screen', 'grade-buttons', 'use-srs', 'fsrs-core', 'db', 'indexed-db', 'ts-fsrs', 'types'] }
    };

    // DOM elements
    const canvas = document.getElementById('canvas');
    const nodesLayer = document.getElementById('nodes-layer');
    const connectionsLayer = document.getElementById('connections-layer');
    const modal = document.getElementById('modal');
    const modalTitle = document.getElementById('modal-title');
    const modalSubtitle = document.getElementById('modal-subtitle');
    const modalTextarea = document.getElementById('modal-textarea');
    const commentsList = document.getElementById('comments-list');
    const commentCount = document.getElementById('comment-count');
    const promptOutput = document.getElementById('prompt-output');
    const copyBtn = document.getElementById('copy-btn');

    function getConnectionStyle(type) {
      switch(type) {
        case 'imports': return { color: '#6b7280', dash: '4,4', marker: 'arrow-gray' };
        case 'data-flow': return { color: '#3b82f6', dash: '', marker: 'arrow-blue' };
        case 'calls': return { color: '#10b981', dash: '6,3', marker: 'arrow-green' };
        default: return { color: '#6b7280', dash: '', marker: 'arrow-gray' };
      }
    }

    function isNodeVisible(node) {
      if (!state.layers[node.layer]) return false;
      const preset = presets[state.activePreset];
      if (preset.filter) return preset.filter.includes(node.id);
      return true;
    }

    function getNodeCenter(node) {
      return { x: node.x + node.w / 2, y: node.y + node.h / 2 };
    }

    function drawConnection(conn) {
      const fromNode = nodes.find(n => n.id === conn.from);
      const toNode = nodes.find(n => n.id === conn.to);
      if (!fromNode || !toNode) return null;
      if (!isNodeVisible(fromNode) || !isNodeVisible(toNode)) return null;
      if (!state.connections[conn.type]) return null;

      const style = getConnectionStyle(conn.type);
      const from = getNodeCenter(fromNode);
      const to = getNodeCenter(toNode);

      // Calculate control points for curved line
      const dx = to.x - from.x;
      const dy = to.y - from.y;
      const mx = (from.x + to.x) / 2;
      const my = (from.y + to.y) / 2;

      // Curve offset
      const offset = Math.min(Math.abs(dx), Math.abs(dy)) * 0.3;
      const cx = mx + (dy > 0 ? offset : -offset) * 0.5;
      const cy = my;

      const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
      path.setAttribute('d', `M ${from.x} ${from.y} Q ${cx} ${cy} ${to.x} ${to.y}`);
      path.setAttribute('fill', 'none');
      path.setAttribute('stroke', style.color);
      path.setAttribute('stroke-width', '1.5');
      path.setAttribute('stroke-opacity', '0.6');
      if (style.dash) path.setAttribute('stroke-dasharray', style.dash);
      path.setAttribute('marker-end', `url(#${style.marker})`);

      return path;
    }

    function drawNode(node) {
      if (!isNodeVisible(node)) return null;

      const g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
      g.setAttribute('class', 'node' + (hasComment(node.id) ? ' commented' : ''));
      g.setAttribute('data-id', node.id);

      const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
      rect.setAttribute('x', node.x);
      rect.setAttribute('y', node.y);
      rect.setAttribute('width', node.w);
      rect.setAttribute('height', node.h);
      rect.setAttribute('rx', '4');
      rect.setAttribute('fill', node.color);
      rect.setAttribute('stroke', hasComment(node.id) ? '#f59e0b' : '#00000020');
      rect.setAttribute('stroke-width', hasComment(node.id) ? '2' : '1');
      g.appendChild(rect);

      const label = document.createElementNS('http://www.w3.org/2000/svg', 'text');
      label.setAttribute('x', node.x + node.w / 2);
      label.setAttribute('y', node.y + 16);
      label.setAttribute('text-anchor', 'middle');
      label.setAttribute('class', 'node-label');
      label.textContent = node.label;
      g.appendChild(label);

      const subtitle = document.createElementNS('http://www.w3.org/2000/svg', 'text');
      subtitle.setAttribute('x', node.x + node.w / 2);
      subtitle.setAttribute('y', node.y + 28);
      subtitle.setAttribute('text-anchor', 'middle');
      subtitle.setAttribute('class', 'node-subtitle');
      subtitle.textContent = node.subtitle.length > 25 ? '...' + node.subtitle.slice(-22) : node.subtitle;
      g.appendChild(subtitle);

      if (hasComment(node.id)) {
        const indicator = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
        indicator.setAttribute('cx', node.x + node.w - 6);
        indicator.setAttribute('cy', node.y + 6);
        indicator.setAttribute('r', '5');
        indicator.setAttribute('class', 'comment-indicator');
        g.appendChild(indicator);
      }

      g.addEventListener('click', () => openModal(node));

      return g;
    }

    function hasComment(nodeId) {
      return state.comments.some(c => c.target === nodeId);
    }

    function render() {
      // Clear layers
      connectionsLayer.innerHTML = '';
      nodesLayer.innerHTML = '';

      // Draw connections
      connections.forEach(conn => {
        const path = drawConnection(conn);
        if (path) connectionsLayer.appendChild(path);
      });

      // Draw nodes
      nodes.forEach(node => {
        const g = drawNode(node);
        if (g) nodesLayer.appendChild(g);
      });

      updateCommentsList();
      updatePrompt();
    }

    function openModal(node) {
      state.selectedNode = node;
      modalTitle.textContent = node.label;
      modalSubtitle.textContent = node.subtitle;

      const existing = state.comments.find(c => c.target === node.id);
      modalTextarea.value = existing ? existing.text : '';
      modalTextarea.placeholder = `Add your comment, question, or request about ${node.label}...\n\nContext: ${node.description}`;

      modal.classList.add('active');
      modalTextarea.focus();
    }

    function closeModal() {
      modal.classList.remove('active');
      state.selectedNode = null;
    }

    function saveComment() {
      if (!state.selectedNode) return;

      const text = modalTextarea.value.trim();
      const existingIndex = state.comments.findIndex(c => c.target === state.selectedNode.id);

      if (text) {
        const comment = {
          id: Date.now(),
          target: state.selectedNode.id,
          targetLabel: state.selectedNode.label,
          targetFile: state.selectedNode.subtitle,
          targetDescription: state.selectedNode.description,
          text: text
        };

        if (existingIndex >= 0) {
          state.comments[existingIndex] = comment;
        } else {
          state.comments.push(comment);
        }
      } else if (existingIndex >= 0) {
        state.comments.splice(existingIndex, 1);
      }

      closeModal();
      render();
    }

    function deleteComment(id) {
      state.comments = state.comments.filter(c => c.id !== id);
      render();
    }

    function updateCommentsList() {
      commentCount.textContent = state.comments.length;

      if (state.comments.length === 0) {
        commentsList.innerHTML = '<div class="empty-comments">Click a node to add a comment</div>';
        return;
      }

      commentsList.innerHTML = state.comments.map(c => `
        <div class="comment-item has-comment">
          <div class="comment-target">${c.targetLabel}</div>
          <div class="comment-file">${c.targetFile}</div>
          <div class="comment-text">${c.text}</div>
          <div class="comment-actions">
            <button class="comment-btn" onclick="openModal(nodes.find(n => n.id === '${c.target}'))">Edit</button>
            <button class="comment-btn delete" onclick="deleteComment(${c.id})">Delete</button>
          </div>
        </div>
      `).join('');
    }

    function updatePrompt() {
      if (state.comments.length === 0) {
        promptOutput.textContent = 'Select components and add comments to generate a prompt...';
        return;
      }

      const visibleLayers = Object.entries(state.layers)
        .filter(([_, v]) => v)
        .map(([k]) => k);

      let prompt = `This is the HAM Exam App architecture`;

      if (visibleLayers.length < 5) {
        const layerNames = { ui: 'UI Components', hooks: 'React Hooks', core: 'Core Logic', storage: 'Storage', data: 'Data Sources' };
        prompt += `, focusing on ${visibleLayers.map(l => layerNames[l]).join(', ')}`;
      }
      prompt += '.\n\n';

      prompt += 'Feedback on specific components:\n\n';

      state.comments.forEach(c => {
        prompt += `**${c.targetLabel}** (${c.targetFile}):\n`;
        prompt += `${c.text}\n\n`;
      });

      promptOutput.textContent = prompt.trim();
    }

    function applyPreset(presetId) {
      const preset = presets[presetId];
      if (!preset) return;

      state.activePreset = presetId;
      state.layers = { ...preset.layers };
      state.connections = { ...preset.connections };

      // Update UI
      document.querySelectorAll('.preset-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.preset === presetId);
      });

      document.querySelectorAll('[data-layer]').forEach(input => {
        input.checked = state.layers[input.dataset.layer];
      });

      document.querySelectorAll('[data-connection]').forEach(input => {
        input.checked = state.connections[input.dataset.connection];
      });

      render();
    }

    function copyPrompt() {
      navigator.clipboard.writeText(promptOutput.textContent).then(() => {
        copyBtn.classList.add('copied');
        copyBtn.querySelector('span').textContent = 'Copied!';
        setTimeout(() => {
          copyBtn.classList.remove('copied');
          copyBtn.querySelector('span').textContent = 'Copy Prompt';
        }, 2000);
      });
    }

    // Zoom and pan
    function updateViewBox() {
      const w = 1000 / state.zoom;
      const h = 600 / state.zoom;
      const x = state.pan.x;
      const y = state.pan.y;
      canvas.setAttribute('viewBox', `${x} ${y} ${w} ${h}`);
    }

    document.getElementById('zoom-in').addEventListener('click', () => {
      state.zoom = Math.min(state.zoom * 1.2, 3);
      updateViewBox();
    });

    document.getElementById('zoom-out').addEventListener('click', () => {
      state.zoom = Math.max(state.zoom / 1.2, 0.5);
      updateViewBox();
    });

    document.getElementById('zoom-reset').addEventListener('click', () => {
      state.zoom = 1;
      state.pan = { x: 0, y: 0 };
      updateViewBox();
    });

    canvas.addEventListener('mousedown', (e) => {
      if (e.target.closest('.node')) return;
      state.dragging = true;
      state.lastMouse = { x: e.clientX, y: e.clientY };
      canvas.style.cursor = 'grabbing';
    });

    canvas.addEventListener('mousemove', (e) => {
      if (!state.dragging) return;
      const dx = (e.clientX - state.lastMouse.x) / state.zoom;
      const dy = (e.clientY - state.lastMouse.y) / state.zoom;
      state.pan.x -= dx;
      state.pan.y -= dy;
      state.lastMouse = { x: e.clientX, y: e.clientY };
      updateViewBox();
    });

    canvas.addEventListener('mouseup', () => {
      state.dragging = false;
      canvas.style.cursor = 'grab';
    });

    canvas.addEventListener('mouseleave', () => {
      state.dragging = false;
      canvas.style.cursor = 'grab';
    });

    // Event listeners
    document.querySelectorAll('.preset-btn').forEach(btn => {
      btn.addEventListener('click', () => applyPreset(btn.dataset.preset));
    });

    document.querySelectorAll('[data-layer]').forEach(input => {
      input.addEventListener('change', () => {
        state.layers[input.dataset.layer] = input.checked;
        state.activePreset = null;
        document.querySelectorAll('.preset-btn').forEach(b => b.classList.remove('active'));
        render();
      });
    });

    document.querySelectorAll('[data-connection]').forEach(input => {
      input.addEventListener('change', () => {
        state.connections[input.dataset.connection] = input.checked;
        render();
      });
    });

    modal.addEventListener('click', (e) => {
      if (e.target === modal) closeModal();
    });

    document.getElementById('modal-cancel').addEventListener('click', closeModal);
    document.getElementById('modal-save').addEventListener('click', saveComment);

    modalTextarea.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) {
        saveComment();
      }
      if (e.key === 'Escape') {
        closeModal();
      }
    });

    copyBtn.addEventListener('click', copyPrompt);

    // Initial render
    render();
  </script>
</body>
</html>
